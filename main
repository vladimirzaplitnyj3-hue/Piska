#!/usr/bin/env python3
"""
RETSING BOT - –ü–æ–ª–Ω–∞—è –≤–µ—Ä—Å–∏—è
–í–µ—Ä—Å–∏—è: 5.0 Pro
"""

import os
import sys
import json
import asyncio
import logging
import traceback
from datetime import datetime, timedelta
from typing import Dict, List, Optional, Any, Set, Union
from dataclasses import dataclass, field
from pathlib import Path
import aiofiles

# –ü—Ä–æ–≤–µ—Ä–∫–∞ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–µ–π
try:
    from telethon import TelegramClient, functions, types
    from telethon.errors import (
        SessionPasswordNeededError,
        PhoneCodeInvalidError,
        PhoneNumberInvalidError,
        FloodWaitError,
        AuthKeyError,
        ChatWriteForbiddenError,
        ChannelPrivateError,
        UserBannedInChannelError
    )
except ImportError:
    print("‚ùå –£—Å—Ç–∞–Ω–æ–≤–∏—Ç–µ –±–∏–±–ª–∏–æ—Ç–µ–∫–∏: pip install telethon aiogram aiofiles")
    sys.exit(1)

try:
    from aiogram import Bot, Dispatcher, types, executor
    from aiogram.contrib.fsm_storage.memory import MemoryStorage
    from aiogram.dispatcher import FSMContext
    from aiogram.dispatcher.filters.state import State, StatesGroup
    from aiogram.types import (
        ReplyKeyboardMarkup,
        KeyboardButton,
        ReplyKeyboardRemove,
        InlineKeyboardMarkup,
        InlineKeyboardButton
    )
except ImportError:
    print("‚ùå –£—Å—Ç–∞–Ω–æ–≤–∏—Ç–µ: pip install aiogram")
    sys.exit(1)

# ========== –ö–û–ù–§–ò–ì–£–†–ê–¶–ò–Ø ==========
class Config:
    """–ö–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è –±–æ—Ç–∞"""
    
    # API –¥–∞–Ω–Ω—ã–µ
    API_ID = 23258474
    API_HASH = "f5dd3f52675030a650ca2259f9fb79ce"
    BOT_TOKEN = "8379847495:AAHQIC5D9fipWz76h3-y0UOsY3amN5RUD_U"
    CREATOR_ID = 7370566881
    
    # –ù–∞—Å—Ç—Ä–æ–π–∫–∏ —Ä–∞—Å—Å—ã–ª–∫–∏
    MESSAGE_SIGNATURE = "\n\n‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ\nüì® –°–æ–æ–±—â–µ–Ω–∏–µ –ø–µ—Ä–µ—Å—ã–ª–∞–µ—Ç –±–µ—Å–ø–ª–∞—Ç–Ω—ã–π –±–æ—Ç –¥–ª—è —Ä–∞—Å—Å—ã–ª–∫–∏ [RETSING BOT](https://t.me/RETSINGBOT)"
    SEND_INTERVAL = 120  # 2 –º–∏–Ω—É—Ç—ã –º–µ–∂–¥—É —Ä–∞—Å—Å—ã–ª–∫–∞–º–∏
    MAX_MESSAGE_LENGTH = 4000
    MAX_CHATS_DISPLAY = 100
    REQUEST_DELAY = 1.5
    
    # –ü—É—Ç–∏
    BASE_DIR = Path(__file__).parent
    SESSIONS_DIR = BASE_DIR / "sessions"
    DATA_DIR = BASE_DIR / "data"
    LOGS_DIR = BASE_DIR / "logs"
    
    # –§–∞–π–ª—ã
    USERS_FILE = DATA_DIR / "users.json"
    LOG_FILE = LOGS_DIR / "bot.log"
    
    @classmethod
    def init_dirs(cls):
        """–°–æ–∑–¥–∞–Ω–∏–µ –¥–∏—Ä–µ–∫—Ç–æ—Ä–∏–π"""
        for dir_path in [cls.SESSIONS_DIR, cls.DATA_DIR, cls.LOGS_DIR]:
            dir_path.mkdir(exist_ok=True)

Config.init_dirs()

# ========== –õ–û–ì–ò–†–û–í–ê–ù–ò–ï ==========
logging.basicConfig(
    level=logging.INFO,
    format='%(asctime)s - %(name)s - %(levelname)s - %(message)s',
    handlers=[
        logging.FileHandler(Config.LOG_FILE, encoding='utf-8', mode='a'),
        logging.StreamHandler()
    ]
)
logger = logging.getLogger(__name__)

# ========== –ú–û–î–ï–õ–ò –î–ê–ù–ù–´–• ==========
@dataclass
class Chat:
    """–ú–æ–¥–µ–ª—å —á–∞—Ç–∞"""
    id: int
    title: str
    type: str
    username: str = ""
    
    @property
    def display_name(self):
        if self.username:
            return f"{self.title} (@{self.username})"
        return self.title

@dataclass
class CampaignStats:
    """–°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ –∫–∞–º–ø–∞–Ω–∏–∏"""
    total_sent: int = 0
    total_failed: int = 0
    start_time: Optional[datetime] = None
    last_send_time: Optional[datetime] = None
    is_active: bool = False
    
    def start(self):
        self.start_time = datetime.now()
        self.is_active = True
    
    def stop(self):
        self.is_active = False
    
    def increment_sent(self):
        self.total_sent += 1
        self.last_send_time = datetime.now()
    
    def increment_failed(self):
        self.total_failed += 1
    
    def get_duration(self):
        if self.start_time:
            return datetime.now() - self.start_time
        return timedelta(0)

@dataclass
class UserData:
    """–î–∞–Ω–Ω—ã–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è"""
    user_id: int
    phone: str = ""
    first_name: str = ""
    is_authenticated: bool = False
    auth_date: Optional[datetime] = None
    message_text: str = ""
    selected_chats: Set[str] = field(default_factory=set)
    all_chats: List[Chat] = field(default_factory=list)
    campaign_stats: CampaignStats = field(default_factory=CampaignStats)
    
    def to_dict(self):
        return {
            'user_id': self.user_id,
            'phone': self.phone,
            'first_name': self.first_name,
            'is_authenticated': self.is_authenticated,
            'auth_date': self.auth_date.isoformat() if self.auth_date else None,
            'message_text': self.message_text,
            'selected_chats': list(self.selected_chats),
            'all_chats': [
                {
                    'id': chat.id,
                    'title': chat.title,
                    'type': chat.type,
                    'username': chat.username
                }
                for chat in self.all_chats
            ],
            'campaign_stats': {
                'total_sent': self.campaign_stats.total_sent,
                'total_failed': self.campaign_stats.total_failed,
                'start_time': self.campaign_stats.start_time.isoformat() if self.campaign_stats.start_time else None,
                'last_send_time': self.campaign_stats.last_send_time.isoformat() if self.campaign_stats.last_send_time else None,
                'is_active': self.campaign_stats.is_active
            }
        }
    
    @classmethod
    def from_dict(cls, data):
        user_data = cls(
            user_id=data['user_id'],
            phone=data.get('phone', ''),
            first_name=data.get('first_name', ''),
            is_authenticated=data.get('is_authenticated', False),
            auth_date=datetime.fromisoformat(data['auth_date']) if data.get('auth_date') else None,
            message_text=data.get('message_text', '')
        )
        
        user_data.selected_chats = set(data.get('selected_chats', []))
        
        chat_list = data.get('all_chats', [])
        user_data.all_chats = [
            Chat(
                id=chat['id'],
                title=chat['title'],
                type=chat['type'],
                username=chat.get('username', '')
            )
            for chat in chat_list
        ]
        
        stats_data = data.get('campaign_stats', {})
        user_data.campaign_stats = CampaignStats(
            total_sent=stats_data.get('total_sent', 0),
            total_failed=stats_data.get('total_failed', 0),
            start_time=datetime.fromisoformat(stats_data['start_time']) if stats_data.get('start_time') else None,
            last_send_time=datetime.fromisoformat(stats_data['last_send_time']) if stats_data.get('last_send_time') else None,
            is_active=stats_data.get('is_active', False)
        )
        
        return user_data

# ========== –ú–ï–ù–ï–î–ñ–ï–† –î–ê–ù–ù–´–• ==========
class DataManager:
    def __init__(self):
        self.users: Dict[int, UserData] = {}
        self.active_tasks: Dict[int, asyncio.Task] = {}
        self.phone_code_hashes: Dict[int, str] = {}  # –í—Ä–µ–º–µ–Ω–Ω–æ–µ —Ö—Ä–∞–Ω–µ–Ω–∏–µ —Ö—ç—à–µ–π –∫–æ–¥–æ–≤
        self.load_data()
    
    def load_data(self):
        try:
            if Config.USERS_FILE.exists():
                async def load():
                    async with aiofiles.open(Config.USERS_FILE, 'r', encoding='utf-8') as f:
                        data = json.loads(await f.read())
                        for user_id_str, user_data in data.items():
                            user = UserData.from_dict(user_data)
                            self.users[user.user_id] = user
                asyncio.run(load())
                logger.info(f"–ó–∞–≥—Ä—É–∂–µ–Ω–æ {len(self.users)} –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π")
        except Exception as e:
            logger.error(f"–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏: {e}")
    
    async def save_data(self):
        try:
            data = {str(uid): user.to_dict() for uid, user in self.users.items()}
            async with aiofiles.open(Config.USERS_FILE, 'w', encoding='utf-8') as f:
                await f.write(json.dumps(data, ensure_ascii=False, indent=2))
        except Exception as e:
            logger.error(f"–û—à–∏–±–∫–∞ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è: {e}")
    
    def get_user(self, user_id: int) -> UserData:
        if user_id not in self.users:
            self.users[user_id] = UserData(user_id=user_id)
        return self.users[user_id]
    
    async def save_user(self, user: UserData):
        self.users[user.user_id] = user
        await self.save_data()
    
    def set_phone_code_hash(self, user_id: int, phone_code_hash: str):
        """–°–æ—Ö—Ä–∞–Ω–∏—Ç—å —Ö—ç—à –∫–æ–¥–∞ –¥–ª—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è"""
        self.phone_code_hashes[user_id] = phone_code_hash
    
    def get_phone_code_hash(self, user_id: int) -> Optional[str]:
        """–ü–æ–ª—É—á–∏—Ç—å —Ö—ç—à –∫–æ–¥–∞ –¥–ª—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è"""
        return self.phone_code_hashes.get(user_id)
    
    def remove_phone_code_hash(self, user_id: int):
        """–£–¥–∞–ª–∏—Ç—å —Ö—ç—à –∫–æ–¥–∞ –ø–æ—Å–ª–µ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è"""
        if user_id in self.phone_code_hashes:
            del self.phone_code_hashes[user_id]

data_manager = DataManager()

# ========== –°–û–°–¢–û–Ø–ù–ò–Ø ==========
class BotStates(StatesGroup):
    waiting_for_phone = State()
    waiting_for_code = State()
    waiting_for_password = State()
    waiting_for_message = State()

# ========== –ò–ù–ò–¶–ò–ê–õ–ò–ó–ê–¶–ò–Ø –ë–û–¢–ê ==========
bot = Bot(token=Config.BOT_TOKEN)
storage = MemoryStorage()
dp = Dispatcher(bot, storage=storage)

# ========== –ö–õ–ê–í–ò–ê–¢–£–†–´ ==========
def get_main_keyboard():
    keyboard = ReplyKeyboardMarkup(resize_keyboard=True, row_width=2)
    keyboard.add(
        "üìù –£–∫–∞–∑–∞—Ç—å —Å–æ–æ–±—â–µ–Ω–∏–µ",
        "üìã –í—ã–±—Ä–∞—Ç—å —á–∞—Ç—ã",
        "üöÄ –ó–∞–ø—É—Å—Ç–∏—Ç—å —Ä–∞—Å—Å—ã–ª–∫—É",
        "‚è∏ –û—Å—Ç–∞–Ω–æ–≤–∏—Ç—å —Ä–∞—Å—Å—ã–ª–∫—É",
        "üìä –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞",
        "üîÑ –û–±–Ω–æ–≤–∏—Ç—å —á–∞—Ç—ã"
    )
    return keyboard

def get_cancel_keyboard():
    keyboard = ReplyKeyboardMarkup(resize_keyboard=True)
    keyboard.add("‚ùå –û—Ç–º–µ–Ω–∞")
    return keyboard

def get_contact_keyboard():
    keyboard = ReplyKeyboardMarkup(resize_keyboard=True)
    keyboard.add(KeyboardButton("üì± –û—Ç–ø—Ä–∞–≤–∏—Ç—å –∫–æ–Ω—Ç–∞–∫—Ç", request_contact=True))
    keyboard.add("‚ùå –û—Ç–º–µ–Ω–∞")
    return keyboard

def create_chats_keyboard(chats: List[Chat], selected_ids: Set[str], page: int = 0):
    PER_PAGE = 8
    start = page * PER_PAGE
    end = start + PER_PAGE
    
    keyboard = []
    for chat in chats[start:end]:
        emoji = "‚úÖ" if str(chat.id) in selected_ids else "‚ùå"
        text = f"{emoji} {chat.title[:25]}"
        keyboard.append([InlineKeyboardButton(text, callback_data=f"chat_{chat.id}")])
    
    # –ù–∞–≤–∏–≥–∞—Ü–∏—è
    nav_row = []
    if page > 0:
        nav_row.append(InlineKeyboardButton("‚óÄÔ∏è", callback_data=f"page_{page-1}"))
    
    total_pages = (len(chats) + PER_PAGE - 1) // PER_PAGE
    page_info = f"üìÑ {page+1}/{total_pages}" if total_pages > 0 else "üìÑ 1/1"
    nav_row.append(InlineKeyboardButton(page_info, callback_data="current_page"))
    
    if end < len(chats):
        nav_row.append(InlineKeyboardButton("‚ñ∂Ô∏è", callback_data=f"page_{page+1}"))
    
    if nav_row:
        keyboard.append(nav_row)
    
    # –ö–Ω–æ–ø–∫–∏ –¥–µ–π—Å—Ç–≤–∏–π
    keyboard.append([
        InlineKeyboardButton("‚úÖ –í—Å—ë", callback_data="select_all"),
        InlineKeyboardButton("‚ùå –ù–∏—á–µ–≥–æ", callback_data="deselect_all")
    ])
    
    keyboard.append([
        InlineKeyboardButton("üíæ –°–æ—Ö—Ä–∞–Ω–∏—Ç—å", callback_data="save_selection")
    ])
    
    return InlineKeyboardMarkup(inline_keyboard=keyboard)

# ========== –•–ï–õ–ü–ï–†–´ ==========
async def get_telegram_client(user_id: int) -> Optional[TelegramClient]:
    """–ü–æ–ª—É—á–µ–Ω–∏–µ –∫–ª–∏–µ–Ω—Ç–∞ Telegram"""
    try:
        session_file = Config.SESSIONS_DIR / f"session_{user_id}"
        client = TelegramClient(
            str(session_file),
            Config.API_ID,
            Config.API_HASH,
            device_model="iPhone 14 Pro",
            system_version="16.0",
            app_version="10.0.0"
        )
        
        await client.connect()
        if await client.is_user_authorized():
            return client
        return None
    except Exception as e:
        logger.error(f"–û—à–∏–±–∫–∞ —Å–æ–∑–¥–∞–Ω–∏—è –∫–ª–∏–µ–Ω—Ç–∞: {e}")
        return None

async def get_user_chats(user_id: int) -> List[Chat]:
    """–ü–æ–ª—É—á–µ–Ω–∏–µ —á–∞—Ç–æ–≤ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è"""
    client = await get_telegram_client(user_id)
    if not client:
        return []
    
    try:
        chats = []
        dialogs = await client.get_dialogs(limit=Config.MAX_CHATS_DISPLAY)
        
        for dialog in dialogs:
            if dialog.is_user or dialog.is_group or dialog.is_channel:
                entity = dialog.entity
                
                chat_type = "private"
                if dialog.is_group:
                    chat_type = "group"
                elif dialog.is_channel:
                    chat_type = "channel"
                
                username = ""
                if hasattr(entity, 'username') and entity.username:
                    username = entity.username
                
                chats.append(Chat(
                    id=entity.id,
                    title=dialog.title,
                    type=chat_type,
                    username=username
                ))
        
        return chats
    except Exception as e:
        logger.error(f"–û—à–∏–±–∫–∞ –ø–æ–ª—É—á–µ–Ω–∏—è —á–∞—Ç–æ–≤: {e}")
        return []
    finally:
        if client:
            await client.disconnect()

async def send_broadcast(user: UserData, client: TelegramClient) -> tuple[int, int]:
    """–û—Ç–ø—Ä–∞–≤–∫–∞ —Ä–∞—Å—Å—ã–ª–∫–∏"""
    success = 0
    failed = 0
    
    for chat_id_str in user.selected_chats:
        try:
            chat_id = int(chat_id_str)
            await client.send_message(
                chat_id,
                user.message_text,
                parse_mode='markdown',
                link_preview=False
            )
            success += 1
            await asyncio.sleep(Config.REQUEST_DELAY)
        except FloodWaitError as e:
            await asyncio.sleep(e.seconds)
            try:
                await client.send_message(chat_id, user.message_text, parse_mode='markdown')
                success += 1
            except:
                failed += 1
        except (ChatWriteForbiddenError, ChannelPrivateError, 
                UserBannedInChannelError, ValueError):
            failed += 1
        except Exception as e:
            logger.error(f"–û—à–∏–±–∫–∞ –æ—Ç–ø—Ä–∞–≤–∫–∏ –≤ —á–∞—Ç {chat_id_str}: {e}")
            failed += 1
    
    return success, failed

async def start_campaign_loop(user_id: int):
    """–ó–∞–ø—É—Å–∫ —Ü–∏–∫–ª–∞ —Ä–∞—Å—Å—ã–ª–∫–∏"""
    user = data_manager.get_user(user_id)
    
    # –û—Ç–º–µ–Ω—è–µ–º –ø—Ä–µ–¥—ã–¥—É—â—É—é –∑–∞–¥–∞—á—É –µ—Å–ª–∏ –µ—Å—Ç—å
    if user_id in data_manager.active_tasks:
        task = data_manager.active_tasks[user_id]
        if not task.done():
            task.cancel()
            try:
                await task
            except asyncio.CancelledError:
                pass
    
    user.campaign_stats.start()
    await data_manager.save_user(user)
    
    # –°–æ–∑–¥–∞–µ–º –Ω–æ–≤—É—é –∑–∞–¥–∞—á—É
    task = asyncio.create_task(_campaign_loop(user_id))
    data_manager.active_tasks[user_id] = task
    
    return task

async def _campaign_loop(user_id: int):
    """–û—Å–Ω–æ–≤–Ω–æ–π —Ü–∏–∫–ª —Ä–∞—Å—Å—ã–ª–∫–∏"""
    user = data_manager.get_user(user_id)
    
    try:
        client = await get_telegram_client(user_id)
        if not client:
            await bot.send_message(user_id, "‚ùå –ù–µ —É–¥–∞–ª–æ—Å—å –ø–æ–¥–∫–ª—é—á–∏—Ç—å—Å—è –∫ –∞–∫–∫–∞—É–Ω—Ç—É")
            user.campaign_stats.stop()
            await data_manager.save_user(user)
            return
        
        iteration = 0
        while user.campaign_stats.is_active:
            iteration += 1
            
            # –û—Ç–ø—Ä–∞–≤–ª—è–µ–º —Ä–∞—Å—Å—ã–ª–∫—É
            start_time = datetime.now()
            success, failed = await send_broadcast(user, client)
            end_time = datetime.now()
            duration = (end_time - start_time).total_seconds()
            
            # –û–±–Ω–æ–≤–ª—è–µ–º —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫—É
            user.campaign_stats.total_sent += success
            user.campaign_stats.total_failed += failed
            user.campaign_stats.last_send_time = end_time
            
            # –û—Ç–ø—Ä–∞–≤–ª—è–µ–º –æ—Ç—á–µ—Ç
            report = (
                f"üìä *–û—Ç—á–µ—Ç #{iteration}*\n\n"
                f"‚úÖ *–£—Å–ø–µ—à–Ω–æ:* {success}\n"
                f"‚ùå *–û—à–∏–±–∫–∏:* {failed}\n"
                f"‚è± *–í—Ä–µ–º—è:* {duration:.1f} —Å–µ–∫.\n"
                f"üì® *–í—Å–µ–≥–æ –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω–æ:* {user.campaign_stats.total_sent}\n"
                f"üîÑ *–°–ª–µ–¥—É—é—â–∞—è –æ—Ç–ø—Ä–∞–≤–∫–∞:* —á–µ—Ä–µ–∑ {Config.SEND_INTERVAL//60} –º–∏–Ω.\n\n"
                f"*–°—Ç–∞—Ç—É—Å:* {'üü¢ –ê–∫—Ç–∏–≤–Ω–∞' if user.campaign_stats.is_active else 'üî¥ –û—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∞'}"
            )
            
            try:
                await bot.send_message(user_id, report, parse_mode='markdown')
            except:
                pass
            
            await data_manager.save_user(user)
            
            # –ñ–¥–µ–º –¥–æ —Å–ª–µ–¥—É—é—â–µ–π —Ä–∞—Å—Å—ã–ª–∫–∏
            if user.campaign_stats.is_active:
                await asyncio.sleep(Config.SEND_INTERVAL)
                
    except asyncio.CancelledError:
        logger.info(f"–†–∞—Å—Å—ã–ª–∫–∞ –æ—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∞ –¥–ª—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è {user_id}")
    except Exception as e:
        logger.error(f"–û—à–∏–±–∫–∞ –≤ —Ü–∏–∫–ª–µ —Ä–∞—Å—Å—ã–ª–∫–∏: {e}")
        try:
            await bot.send_message(user_id, f"‚ùå *–û—à–∏–±–∫–∞ —Ä–∞—Å—Å—ã–ª–∫–∏:* {str(e)[:100]}", parse_mode='markdown')
        except:
            pass
    finally:
        if user_id in data_manager.active_tasks:
            del data_manager.active_tasks[user_id]
        user.campaign_stats.stop()
        await data_manager.save_user(user)

# ========== –û–°–ù–û–í–ù–´–ï –û–ë–†–ê–ë–û–¢–ß–ò–ö–ò ==========
@dp.message_handler(commands=['start', 'help'])
async def cmd_start(message: types.Message):
    user_id = message.from_user.id
    user = data_manager.get_user(user_id)
    
    welcome_text = (
        f"üëã *–î–æ–±—Ä–æ –ø–æ–∂–∞–ª–æ–≤–∞—Ç—å –≤ RETSING BOT!*\n\n"
        f"ü§ñ *–ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∞—è —Å–∏—Å—Ç–µ–º–∞ —Ä–∞—Å—Å—ã–ª–∫–∏ —Å–æ–æ–±—â–µ–Ω–∏–π*\n\n"
        f"üìå *–ö–∞–∫ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å:*\n"
        f"1. –ü–æ–¥–∫–ª—é—á–∏—Ç–µ –∞–∫–∫–∞—É–Ω—Ç (–æ—Ç–ø—Ä–∞–≤—å—Ç–µ –∫–æ–Ω—Ç–∞–∫—Ç)\n"
        f"2. –£–∫–∞–∂–∏—Ç–µ —Å–æ–æ–±—â–µ–Ω–∏–µ –¥–ª—è —Ä–∞—Å—Å—ã–ª–∫–∏\n"
        f"3. –í—ã–±–µ—Ä–∏—Ç–µ —á–∞—Ç—ã –∏–∑ —Å–ø–∏—Å–∫–∞\n"
        f"4. –ó–∞–ø—É—Å—Ç–∏—Ç–µ —Ä–∞—Å—Å—ã–ª–∫—É –∫–æ–º–∞–Ω–¥–æ–π /launch\n"
        f"5. –û—Å—Ç–∞–Ω–æ–≤–∏—Ç–µ –∫–æ–º–∞–Ω–¥–æ–π /stop\n\n"
        f"‚ö° *–†–∞—Å—Å—ã–ª–∫–∞ –±—É–¥–µ—Ç –ø–æ–≤—Ç–æ—Ä—è—Ç—å—Å—è –∫–∞–∂–¥—ã–µ 2 –º–∏–Ω—É—Ç—ã*\n"
        f"üìä *–í—ã –±—É–¥–µ—Ç–µ –ø–æ–ª—É—á–∞—Ç—å –ø–æ–¥—Ä–æ–±–Ω—É—é —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫—É*"
    )
    
    if user.is_authenticated:
        status = "üü¢ –ê–∫—Ç–∏–≤–Ω–∞" if user.campaign_stats.is_active else "‚ö™ –û—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∞"
        await message.answer(
            f"‚úÖ *–í—ã –∞–≤—Ç–æ—Ä–∏–∑–æ–≤–∞–Ω—ã –∫–∞–∫:* {user.phone}\n\n"
            f"üìä *–°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞:*\n"
            f"‚Ä¢ üì® –û—Ç–ø—Ä–∞–≤–ª–µ–Ω–æ: {user.campaign_stats.total_sent}\n"
            f"‚Ä¢ ‚ùå –û—à–∏–±–æ–∫: {user.campaign_stats.total_failed}\n"
            f"‚Ä¢ üìã –ß–∞—Ç–æ–≤ –≤—ã–±—Ä–∞–Ω–æ: {len(user.selected_chats)}\n"
            f"‚Ä¢ üöÄ –°—Ç–∞—Ç—É—Å —Ä–∞—Å—Å—ã–ª–∫–∏: {status}\n\n"
            f"*–ò—Å–ø–æ–ª—å–∑—É–π—Ç–µ –º–µ–Ω—é –¥–ª—è —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è:*",
            parse_mode='markdown',
            reply_markup=get_main_keyboard()
        )
    else:
        await message.answer(
            welcome_text,
            parse_mode='markdown',
            reply_markup=get_contact_keyboard()
        )
        await BotStates.waiting_for_phone.set()

@dp.message_handler(content_types=['contact'], state=BotStates.waiting_for_phone)
async def process_contact(message: types.Message, state: FSMContext):
    if not message.contact:
        await message.answer("‚ùå –û—Ç–ø—Ä–∞–≤—å—Ç–µ –∫–æ–Ω—Ç–∞–∫—Ç –¥–ª—è –ø—Ä–æ–¥–æ–ª–∂–µ–Ω–∏—è", reply_markup=get_contact_keyboard())
        return
    
    user_id = message.from_user.id
    user = data_manager.get_user(user_id)
    
    user.phone = message.contact.phone_number
    user.first_name = message.contact.first_name or ""
    await data_manager.save_user(user)
    
    session_file = Config.SESSIONS_DIR / f"session_{user_id}"
    client = TelegramClient(str(session_file), Config.API_ID, Config.API_HASH)
    
    try:
        await client.connect()
        sent_code = await client.send_code_request(user.phone)
        
        # –°–æ—Ö—Ä–∞–Ω—è–µ–º —Ö—ç—à –∫–æ–¥–∞ –≤ DataManager –≤–º–µ—Å—Ç–æ —Å–æ—Å—Ç–æ—è–Ω–∏—è
        data_manager.set_phone_code_hash(user_id, sent_code.phone_code_hash)
        
        await message.answer(
            f"‚úÖ *–ö–æ–¥ –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω –Ω–∞:* `{user.phone}`\n\n"
            f"üìù *–í–≤–µ–¥–∏—Ç–µ –∫–æ–¥ –∏–∑ Telegram:*",
            parse_mode='markdown',
            reply_markup=get_cancel_keyboard()
        )
        
        await BotStates.waiting_for_code.set()
        
    except FloodWaitError as e:
        await message.answer(f"‚è≥ *–ñ–¥–∏—Ç–µ {e.seconds} —Å–µ–∫—É–Ω–¥*", parse_mode='markdown')
        await state.finish()
    except PhoneNumberInvalidError:
        await message.answer("‚ùå *–ù–µ–≤–µ—Ä–Ω—ã–π –Ω–æ–º–µ—Ä —Ç–µ–ª–µ—Ñ–æ–Ω–∞*", parse_mode='markdown')
        await state.finish()
    except Exception as e:
        await message.answer(f"‚ùå *–û—à–∏–±–∫–∞:* {str(e)[:100]}", parse_mode='markdown')
        await state.finish()
    finally:
        # –û—Ç–∫–ª—é—á–∞–µ–º –∫–ª–∏–µ–Ω—Ç, –æ–Ω –Ω–µ –¥–æ–ª–∂–µ–Ω –æ—Å—Ç–∞–≤–∞—Ç—å—Å—è –≤ —Å–æ—Å—Ç–æ—è–Ω–∏–∏
        try:
            await client.disconnect()
        except:
            pass

@dp.message_handler(state=BotStates.waiting_for_code)
async def process_code(message: types.Message, state: FSMContext):
    user_id = message.from_user.id
    
    if message.text == "‚ùå –û—Ç–º–µ–Ω–∞":
        await message.answer("‚ùå –û—Ç–º–µ–Ω–µ–Ω–æ", reply_markup=ReplyKeyboardRemove())
        await state.finish()
        return
    
    # –ü—Ä–æ–≤–µ—Ä—è–µ–º, —á—Ç–æ —ç—Ç–æ –∫–æ–¥ (—Ü–∏—Ñ—Ä—ã)
    code = message.text.strip()
    
    # –ë–û–õ–ï–ï –ì–ò–ë–ö–ê–Ø –ü–†–û–í–ï–†–ö–ê –ö–û–î–ê - –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–æ
    # –ö–æ–¥ –º–æ–∂–µ—Ç –±—ã—Ç—å 5 –∏–ª–∏ 6 —Ü–∏—Ñ—Ä, –∏–Ω–æ–≥–¥–∞ —Å –ø—Ä–æ–±–µ–ª–∞–º–∏ –∏–ª–∏ –¥–µ—Ñ–∏—Å–∞–º–∏
    code_digits = ''.join(filter(str.isdigit, code))
    
    if not code_digits or len(code_digits) < 5 or len(code_digits) > 6:
        await message.answer(
            "‚ùå *–ù–µ–≤–µ—Ä–Ω—ã–π —Ñ–æ—Ä–º–∞—Ç –∫–æ–¥–∞!*\n\n"
            "üìù *–í–≤–µ–¥–∏—Ç–µ –∫–æ–¥ –∏–∑ Telegram (5-6 —Ü–∏—Ñ—Ä):*",
            parse_mode='markdown',
            reply_markup=get_cancel_keyboard()
        )
        return
    
    user = data_manager.get_user(user_id)
    phone_code_hash = data_manager.get_phone_code_hash(user_id)
    
    if not phone_code_hash:
        await message.answer("‚ùå –û—à–∏–±–∫–∞: —Å–µ—Å—Å–∏—è —É—Å—Ç–∞—Ä–µ–ª–∞. –ù–∞—á–Ω–∏—Ç–µ –∑–∞–Ω–æ–≤–æ /start", parse_mode='markdown')
        await state.finish()
        return
    
    # –°–æ–∑–¥–∞–µ–º –Ω–æ–≤—ã–π –∫–ª–∏–µ–Ω—Ç
    session_file = Config.SESSIONS_DIR / f"session_{user_id}"
    client = TelegramClient(str(session_file), Config.API_ID, Config.API_HASH)
    
    try:
        await client.connect()
        
        # –ü—Ä–æ–±—É–µ–º –≤–æ–π—Ç–∏ —Å –∫–æ–¥–æ–º
        try:
            await client.sign_in(
                phone=user.phone,
                code=code_digits,
                phone_code_hash=phone_code_hash
            )
            
            user.is_authenticated = True
            user.auth_date = datetime.now()
            await data_manager.save_user(user)
            
            await message.answer(
                "‚úÖ *–ê–∫–∫–∞—É–Ω—Ç —É—Å–ø–µ—à–Ω–æ –ø–æ–¥–∫–ª—é—á–µ–Ω!*\n\n"
                "–¢–µ–ø–µ—Ä—å –≤—ã –º–æ–∂–µ—Ç–µ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å –≤—Å–µ —Ñ—É–Ω–∫—Ü–∏–∏ –±–æ—Ç–∞.",
                parse_mode='markdown',
                reply_markup=get_main_keyboard()
            )
            
        except SessionPasswordNeededError:
            # –°–æ—Ö—Ä–∞–Ω—è–µ–º –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é –æ —Å–æ—Å—Ç–æ—è–Ω–∏–∏ –¥–ª—è –≤–≤–æ–¥–∞ –ø–∞—Ä–æ–ª—è
            await state.update_data(
                phone=user.phone,
                phone_code_hash=phone_code_hash
            )
            
            await message.answer(
                "üîê *–¢—Ä–µ–±—É–µ—Ç—Å—è –¥–≤—É—Ö—Ñ–∞–∫—Ç–æ—Ä–Ω–∞—è –∞—É—Ç–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ü–∏—è*\n"
                "üìù *–í–≤–µ–¥–∏—Ç–µ –ø–∞—Ä–æ–ª—å –æ—Ç –∞–∫–∫–∞—É–Ω—Ç–∞ Telegram:*",
                parse_mode='markdown',
                reply_markup=get_cancel_keyboard()
            )
            
            await BotStates.waiting_for_password.set()
            return
            
        except PhoneCodeInvalidError:
            await message.answer(
                "‚ùå *–ù–µ–≤–µ—Ä–Ω—ã–π –∫–æ–¥!*\n\n"
                "üìù *–ü–æ–ø—Ä–æ–±—É–π—Ç–µ –µ—â–µ —Ä–∞–∑:*",
                parse_mode='markdown',
                reply_markup=get_cancel_keyboard()
            )
            return
            
        except Exception as e:
            await message.answer(f"‚ùå *–û—à–∏–±–∫–∞ –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏–∏:* {str(e)[:100]}", parse_mode='markdown')
            await state.finish()
            
    except Exception as e:
        await message.answer(f"‚ùå *–û—à–∏–±–∫–∞ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è:* {str(e)[:100]}", parse_mode='markdown')
        await state.finish()
    finally:
        # –û—á–∏—â–∞–µ–º —Ö—ç—à –∫–æ–¥–∞
        data_manager.remove_phone_code_hash(user_id)
        try:
            await client.disconnect()
        except:
            pass
        
        if not await state.get_state():
            await state.finish()

@dp.message_handler(state=BotStates.waiting_for_password)
async def process_password(message: types.Message, state: FSMContext):
    user_id = message.from_user.id
    
    if message.text == "‚ùå –û—Ç–º–µ–Ω–∞":
        await message.answer("‚ùå –û—Ç–º–µ–Ω–µ–Ω–æ", reply_markup=ReplyKeyboardRemove())
        await state.finish()
        return
    
    data = await state.get_data()
    phone = data.get('phone')
    phone_code_hash = data.get('phone_code_hash')
    
    if not phone or not phone_code_hash:
        await message.answer("‚ùå –û—à–∏–±–∫–∞ —Å–µ—Å—Å–∏–∏. –ù–∞—á–Ω–∏—Ç–µ –∑–∞–Ω–æ–≤–æ /start", parse_mode='markdown')
        await state.finish()
        return
    
    # –°–æ–∑–¥–∞–µ–º –Ω–æ–≤—ã–π –∫–ª–∏–µ–Ω—Ç
    session_file = Config.SESSIONS_DIR / f"session_{user_id}"
    client = TelegramClient(str(session_file), Config.API_ID, Config.API_HASH)
    
    try:
        await client.connect()
        
        # –ü—ã—Ç–∞–µ–º—Å—è –≤–æ–π—Ç–∏ —Å –ø–∞—Ä–æ–ª–µ–º
        try:
            await client.sign_in(password=message.text)
            
            user = data_manager.get_user(user_id)
            user.is_authenticated = True
            user.auth_date = datetime.now()
            await data_manager.save_user(user)
            
            await message.answer(
                "‚úÖ *–ê–∫–∫–∞—É–Ω—Ç –ø–æ–¥–∫–ª—é—á–µ–Ω!*\n\n"
                "–¢–µ–ø–µ—Ä—å –≤—ã –º–æ–∂–µ—Ç–µ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å –≤—Å–µ —Ñ—É–Ω–∫—Ü–∏–∏ –±–æ—Ç–∞.",
                parse_mode='markdown',
                reply_markup=get_main_keyboard()
            )
            
        except Exception as e:
            await message.answer(f"‚ùå *–û—à–∏–±–∫–∞ –≤—Ö–æ–¥–∞:* {str(e)[:100]}", parse_mode='markdown')
            
    except Exception as e:
        await message.answer(f"‚ùå *–û—à–∏–±–∫–∞ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è:* {str(e)[:100]}", parse_mode='markdown')
    finally:
        try:
            await client.disconnect()
        except:
            pass
        await state.finish()

@dp.message_handler(lambda m: m.text == "üìù –£–∫–∞–∑–∞—Ç—å —Å–æ–æ–±—â–µ–Ω–∏–µ")
async def set_message_handler(message: types.Message):
    user_id = message.from_user.id
    user = data_manager.get_user(user_id)
    
    if not user.is_authenticated:
        await message.answer("‚ùå –°–Ω–∞—á–∞–ª–∞ –ø–æ–¥–∫–ª—é—á–∏—Ç–µ –∞–∫–∫–∞—É–Ω—Ç —á–µ—Ä–µ–∑ /start", parse_mode='markdown')
        return
    
    await message.answer(
        "üìù *–í–≤–µ–¥–∏—Ç–µ —Ç–µ–∫—Å—Ç –¥–ª—è —Ä–∞—Å—Å—ã–ª–∫–∏:*\n\n"
        "‚ÑπÔ∏è *–ü—Ä–∏–º–µ—á–∞–Ω–∏–µ:* –ö —Å–æ–æ–±—â–µ–Ω–∏—é –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –¥–æ–±–∞–≤–∏—Ç—Å—è –ø–æ–¥–ø–∏—Å—å –±–æ—Ç–∞",
        parse_mode='markdown',
        reply_markup=get_cancel_keyboard()
    )
    await BotStates.waiting_for_message.set()

@dp.message_handler(state=BotStates.waiting_for_message)
async def process_message_text(message: types.Message, state: FSMContext):
    if message.text == "‚ùå –û—Ç–º–µ–Ω–∞":
        await message.answer("‚ùå –û—Ç–º–µ–Ω–µ–Ω–æ", reply_markup=get_main_keyboard())
        await state.finish()
        return
    
    user_id = message.from_user.id
    user = data_manager.get_user(user_id)
    
    # –î–æ–±–∞–≤–ª—è–µ–º –ø–æ–¥–ø–∏—Å—å
    full_message = message.text + Config.MESSAGE_SIGNATURE
    
    if len(full_message) > Config.MAX_MESSAGE_LENGTH:
        await message.answer(f"‚ùå –°–æ–æ–±—â–µ–Ω–∏–µ —Å–ª–∏—à–∫–æ–º –¥–ª–∏–Ω–Ω–æ–µ ({len(full_message)}/{Config.MAX_MESSAGE_LENGTH})", parse_mode='markdown')
        return
    
    user.message_text = full_message
    await data_manager.save_user(user)
    
    preview = full_message[:200] + "..." if len(full_message) > 200 else full_message
    await message.answer(
        f"‚úÖ *–°–æ–æ–±—â–µ–Ω–∏–µ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–æ!*\n\n"
        f"*–ü—Ä–µ–¥–ø—Ä–æ—Å–º–æ—Ç—Ä:*\n{preview}\n\n"
        f"üìä *–î–ª–∏–Ω–∞:* {len(full_message)} —Å–∏–º–≤–æ–ª–æ–≤",
        parse_mode='markdown',
        reply_markup=get_main_keyboard()
    )
    await state.finish()

@dp.message_handler(lambda m: m.text == "üìã –í—ã–±—Ä–∞—Ç—å —á–∞—Ç—ã")
async def select_chats_handler(message: types.Message):
    user_id = message.from_user.id
    user = data_manager.get_user(user_id)
    
    if not user.is_authenticated:
        await message.answer("‚ùå –°–Ω–∞—á–∞–ª–∞ –ø–æ–¥–∫–ª—é—á–∏—Ç–µ –∞–∫–∫–∞—É–Ω—Ç", parse_mode='markdown')
        return
    
    if not user.message_text:
        await message.answer("‚ùå –°–Ω–∞—á–∞–ª–∞ —É–∫–∞–∂–∏—Ç–µ —Å–æ–æ–±—â–µ–Ω–∏–µ", parse_mode='markdown')
        return
    
    await message.answer("üîÑ *–ü–æ–ª—É—á–∞—é —Å–ø–∏—Å–æ–∫ –≤–∞—à–∏—Ö —á–∞—Ç–æ–≤...*", parse_mode='markdown')
    
    chats = await get_user_chats(user_id)
    if not chats:
        await message.answer("‚ùå –ù–µ —É–¥–∞–ª–æ—Å—å –ø–æ–ª—É—á–∏—Ç—å —á–∞—Ç—ã. –ü—Ä–æ–≤–µ—Ä—å—Ç–µ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏–µ.", parse_mode='markdown')
        return
    
    user.all_chats = chats
    await data_manager.save_user(user)
    
    keyboard = create_chats_keyboard(chats, user.selected_chats)
    
    await message.answer(
        f"üìã *–í—ã–±–µ—Ä–∏—Ç–µ —á–∞—Ç—ã –¥–ª—è —Ä–∞—Å—Å—ã–ª–∫–∏:*\n"
        f"‚úÖ - –≤—ã–±—Ä–∞–Ω, ‚ùå - –Ω–µ –≤—ã–±—Ä–∞–Ω\n\n"
        f"*–ù–∞–π–¥–µ–Ω–æ:* {len(chats)} —á–∞—Ç–æ–≤\n"
        f"*–í—ã–±—Ä–∞–Ω–æ:* {len(user.selected_chats)}",
        parse_mode='markdown',
        reply_markup=keyboard
    )

@dp.callback_query_handler(lambda c: c.data.startswith('chat_'))
async def process_chat_selection(callback_query: types.CallbackQuery):
    user_id = callback_query.from_user.id
    user = data_manager.get_user(user_id)
    
    chat_id = callback_query.data.split('_')[1]
    
    if chat_id in user.selected_chats:
        user.selected_chats.remove(chat_id)
    else:
        user.selected_chats.add(chat_id)
    
    await data_manager.save_user(user)
    
    keyboard = create_chats_keyboard(user.all_chats, user.selected_chats)
    await callback_query.message.edit_reply_markup(reply_markup=keyboard)
    await callback_query.answer()

@dp.callback_query_handler(lambda c: c.data.startswith('page_'))
async def process_page_change(callback_query: types.CallbackQuery):
    user_id = callback_query.from_user.id
    user = data_manager.get_user(user_id)
    
    page = int(callback_query.data.split('_')[1])
    keyboard = create_chats_keyboard(user.all_chats, user.selected_chats, page)
    
    await callback_query.message.edit_reply_markup(reply_markup=keyboard)
    await callback_query.answer()

@dp.callback_query_handler(lambda c: c.data == 'select_all')
async def select_all_chats(callback_query: types.CallbackQuery):
    user_id = callback_query.from_user.id
    user = data_manager.get_user(user_id)
    
    user.selected_chats = {str(chat.id) for chat in user.all_chats}
    await data_manager.save_user(user)
    
    keyboard = create_chats_keyboard(user.all_chats, user.selected_chats)
    await callback_query.message.edit_reply_markup(reply_markup=keyboard)
    await callback_query.answer("‚úÖ –í—Å–µ —á–∞—Ç—ã –≤—ã–±—Ä–∞–Ω—ã")

@dp.callback_query_handler(lambda c: c.data == 'deselect_all')
async def deselect_all_chats(callback_query: types.CallbackQuery):
    user_id = callback_query.from_user.id
    user = data_manager.get_user(user_id)
    
    user.selected_chats.clear()
    await data_manager.save_user(user)
    
    keyboard = create_chats_keyboard(user.all_chats, user.selected_chats)
    await callback_query.message.edit_reply_markup(reply_markup=keyboard)
    await callback_query.answer("‚ùå –í—ã–±–æ—Ä –æ—á–∏—â–µ–Ω")

@dp.callback_query_handler(lambda c: c.data == 'save_selection')
async def save_chats_selection(callback_query: types.CallbackQuery):
    user_id = callback_query.from_user.id
    user = data_manager.get_user(user_id)
    
    await callback_query.message.edit_text(
        f"‚úÖ *–°–ø–∏—Å–æ–∫ —á–∞—Ç–æ–≤ —Å–æ—Ö—Ä–∞–Ω–µ–Ω!*\n\n"
        f"üìä *–°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞:*\n"
        f"‚Ä¢ –í—Å–µ–≥–æ —á–∞—Ç–æ–≤: {len(user.all_chats)}\n"
        f"‚Ä¢ –í—ã–±—Ä–∞–Ω–æ: {len(user.selected_chats)}\n\n"
        f"–¢–µ–ø–µ—Ä—å –º–æ–∂–Ω–æ –∑–∞–ø—É—Å—Ç–∏—Ç—å —Ä–∞—Å—Å—ã–ª–∫—É –∫–æ–º–∞–Ω–¥–æ–π /launch",
        parse_mode='markdown'
    )
    await callback_query.answer()

@dp.message_handler(commands=['launch'])
@dp.message_handler(lambda m: m.text == "üöÄ –ó–∞–ø—É—Å—Ç–∏—Ç—å —Ä–∞—Å—Å—ã–ª–∫—É")
async def launch_campaign(message: types.Message):
    user_id = message.from_user.id
    user = data_manager.get_user(user_id)
    
    if not user.is_authenticated:
        await message.answer("‚ùå –°–Ω–∞—á–∞–ª–∞ –ø–æ–¥–∫–ª—é—á–∏—Ç–µ –∞–∫–∫–∞—É–Ω—Ç —á–µ—Ä–µ–∑ /start", parse_mode='markdown')
        return
    
    if not user.message_text:
        await message.answer("‚ùå –°–Ω–∞—á–∞–ª–∞ —É–∫–∞–∂–∏—Ç–µ —Å–æ–æ–±—â–µ–Ω–∏–µ –¥–ª—è —Ä–∞—Å—Å—ã–ª–∫–∏", parse_mode='markdown')
        return
    
    if not user.selected_chats:
        await message.answer("‚ùå –°–Ω–∞—á–∞–ª–∞ –≤—ã–±–µ—Ä–∏—Ç–µ —á–∞—Ç—ã –¥–ª—è —Ä–∞—Å—Å—ã–ª–∫–∏", parse_mode='markdown')
        return
    
    if user.campaign_stats.is_active:
        await message.answer("‚ö†Ô∏è –†–∞—Å—Å—ã–ª–∫–∞ —É–∂–µ –∑–∞–ø—É—â–µ–Ω–∞! –ò—Å–ø–æ–ª—å–∑—É–π—Ç–µ /stop –¥–ª—è –æ—Å—Ç–∞–Ω–æ–≤–∫–∏", parse_mode='markdown')
        return
    
    # –ó–∞–ø—É—Å–∫–∞–µ–º —Ä–∞—Å—Å—ã–ª–∫—É
    await start_campaign_loop(user_id)
    
    await message.answer(
        "üöÄ *–†–∞—Å—Å—ã–ª–∫–∞ –∑–∞–ø—É—â–µ–Ω–∞!*\n\n"
        f"üì® *–°–æ–æ–±—â–µ–Ω–∏–µ:* {len(user.message_text)} —Å–∏–º–≤–æ–ª–æ–≤\n"
        f"üìã *–ß–∞—Ç–æ–≤:* {len(user.selected_chats)}\n"
        f"‚è± *–ò–Ω—Ç–µ—Ä–≤–∞–ª:* {Config.SEND_INTERVAL//60} –º–∏–Ω—É—Ç\n\n"
        f"üìä *–°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ –±—É–¥–µ—Ç –ø—Ä–∏—Ö–æ–¥–∏—Ç—å –∫–∞–∂–¥—ã–µ {Config.SEND_INTERVAL//60} –º–∏–Ω—É—Ç*\n"
        f"üõë *–î–ª—è –æ—Å—Ç–∞–Ω–æ–≤–∫–∏ –∏—Å–ø–æ–ª—å–∑—É–π—Ç–µ /stop*",
        parse_mode='markdown'
    )

@dp.message_handler(commands=['stop'])
@dp.message_handler(lambda m: m.text == "‚è∏ –û—Å—Ç–∞–Ω–æ–≤–∏—Ç—å —Ä–∞—Å—Å—ã–ª–∫—É")
async def stop_campaign(message: types.Message):
    user_id = message.from_user.id
    user = data_manager.get_user(user_id)
    
    if not user.campaign_stats.is_active:
        await message.answer("‚ÑπÔ∏è –†–∞—Å—Å—ã–ª–∫–∞ –Ω–µ –∞–∫—Ç–∏–≤–Ω–∞", parse_mode='markdown')
        return
    
    # –û—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –∑–∞–¥–∞—á—É
    if user_id in data_manager.active_tasks:
        task = data_manager.active_tasks[user_id]
        task.cancel()
        try:
            await task
        except asyncio.CancelledError:
            pass
        del data_manager.active_tasks[user_id]
    
    user.campaign_stats.stop()
    await data_manager.save_user(user)
    
    duration = user.campaign_stats.get_duration()
    hours = duration.seconds // 3600
    minutes = (duration.seconds % 3600) // 60
    
    await message.answer(
        f"üõë *–†–∞—Å—Å—ã–ª–∫–∞ –æ—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∞!*\n\n"
        f"üìä *–ò—Ç–æ–≥–æ–≤–∞—è —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞:*\n"
        f"‚Ä¢ üïê –î–ª–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å: {hours}—á {minutes}–º\n"
        f"‚Ä¢ üì® –û—Ç–ø—Ä–∞–≤–ª–µ–Ω–æ: {user.campaign_stats.total_sent}\n"
        f"‚Ä¢ ‚ùå –û—à–∏–±–æ–∫: {user.campaign_stats.total_failed}\n"
        f"‚Ä¢ üìã –ß–∞—Ç–æ–≤: {len(user.selected_chats)}\n\n"
        f"üöÄ *–î–ª—è –Ω–æ–≤–æ–≥–æ –∑–∞–ø—É—Å–∫–∞ –∏—Å–ø–æ–ª—å–∑—É–π—Ç–µ /launch*",
        parse_mode='markdown'
    )

@dp.message_handler(commands=['status'])
@dp.message_handler(lambda m: m.text == "üìä –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞")
async def show_stats(message: types.Message):
    user_id = message.from_user.id
    user = data_manager.get_user(user_id)
    
    if not user.is_authenticated:
        await message.answer("‚ùå –°–Ω–∞—á–∞–ª–∞ –ø–æ–¥–∫–ª—é—á–∏—Ç–µ –∞–∫–∫–∞—É–Ω—Ç", parse_mode='markdown')
        return
    
    duration = user.campaign_stats.get_duration()
    total_messages = user.campaign_stats.total_sent + user.campaign_stats.total_failed
    
    if total_messages > 0:
        success_rate = (user.campaign_stats.total_sent / total_messages) * 100
    else:
        success_rate = 0
    
    stats_text = (
        f"üìä *–í–∞—à–∞ —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞:*\n\n"
        f"üë§ *–ê–∫–∫–∞—É–Ω—Ç:* {user.phone}\n"
        f"üìÖ *–ü–æ–¥–∫–ª—é—á–µ–Ω:* {user.auth_date.strftime('%d.%m.%Y %H:%M') if user.auth_date else '–ù–µ–∏–∑–≤–µ—Å—Ç–Ω–æ'}\n\n"
        f"üì® *–†–∞—Å—Å—ã–ª–∫–∞:*\n"
        f"‚Ä¢ üöÄ –°—Ç–∞—Ç—É—Å: {'üü¢ –ê–ö–¢–ò–í–ù–ê' if user.campaign_stats.is_active else 'üî¥ –û–°–¢–ê–ù–û–í–õ–ï–ù–ê'}\n"
        f"‚Ä¢ üì® –£—Å–ø–µ—à–Ω–æ: {user.campaign_stats.total_sent}\n"
        f"‚Ä¢ ‚ùå –û—à–∏–±–æ–∫: {user.campaign_stats.total_failed}\n"
        f"‚Ä¢ üìà –£—Å–ø–µ—à–Ω–æ—Å—Ç—å: {success_rate:.1f}%\n"
        f"‚Ä¢ üïê –î–ª–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å: {duration.days}–¥ {duration.seconds//3600}—á {(duration.seconds%3600)//60}–º\n\n"
        f"üìã *–ù–∞—Å—Ç—Ä–æ–π–∫–∏:*\n"
        f"‚Ä¢ üìù –°–æ–æ–±—â–µ–Ω–∏–µ: {'‚úÖ –£—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–æ' if user.message_text else '‚ùå –ù–µ —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–æ'}\n"
        f"‚Ä¢ üìã –ß–∞—Ç–æ–≤ –≤—ã–±—Ä–∞–Ω–æ: {len(user.selected_chats)}\n"
        f"‚Ä¢ üìÇ –í—Å–µ–≥–æ —á–∞—Ç–æ–≤ –≤ –±–∞–∑–µ: {len(user.all_chats)}"
    )
    
    await message.answer(stats_text, parse_mode='markdown')

@dp.message_handler(commands=['refresh'])
@dp.message_handler(lambda m: m.text == "üîÑ –û–±–Ω–æ–≤–∏—Ç—å —á–∞—Ç—ã")
async def refresh_chats(message: types.Message):
    user_id = message.from_user.id
    user = data_manager.get_user(user_id)
    
    if not user.is_authenticated:
        await message.answer("‚ùå –°–Ω–∞—á–∞–ª–∞ –ø–æ–¥–∫–ª—é—á–∏—Ç–µ –∞–∫–∫–∞—É–Ω—Ç", parse_mode='markdown')
        return
    
    await message.answer("üîÑ *–û–±–Ω–æ–≤–ª—è—é —Å–ø–∏—Å–æ–∫ —á–∞—Ç–æ–≤...*", parse_mode='markdown')
    
    chats = await get_user_chats(user_id)
    if not chats:
        await message.answer("‚ùå –ù–µ —É–¥–∞–ª–æ—Å—å –æ–±–Ω–æ–≤–∏—Ç—å —á–∞—Ç—ã", parse_mode='markdown')
        return
    
    old_count = len(user.all_chats)
    user.all_chats = chats
    
    # –°–æ—Ö—Ä–∞–Ω—è–µ–º —Ç–æ–ª—å–∫–æ —Ç–µ –≤—ã–±—Ä–∞–Ω–Ω—ã–µ —á–∞—Ç—ã, –∫–æ—Ç–æ—Ä—ã–µ –≤—Å–µ –µ—â–µ —Å—É—â–µ—Å—Ç–≤—É—é—Ç
    existing_chat_ids = {str(chat.id) for chat in chats}
    old_selected = len(user.selected_chats)
    user.selected_chats = user.selected_chats.intersection(existing_chat_ids)
    removed_count = old_selected - len(user.selected_chats)
    
    await data_manager.save_user(user)
    
    await message.answer(
        f"‚úÖ *–°–ø–∏—Å–æ–∫ —á–∞—Ç–æ–≤ –æ–±–Ω–æ–≤–ª–µ–Ω!*\n\n"
        f"üìä *–°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞:*\n"
        f"‚Ä¢ –ù–∞–π–¥–µ–Ω–æ —á–∞—Ç–æ–≤: {len(chats)}\n"
        f"‚Ä¢ –ë—ã–ª–æ: {old_count}\n"
        f"‚Ä¢ –ò–∑–º–µ–Ω–µ–Ω–∏–µ: {len(chats) - old_count:+}\n"
        f"‚Ä¢ –í—ã–±—Ä–∞–Ω–æ: {len(user.selected_chats)}\n"
        f"‚Ä¢ –£–¥–∞–ª–µ–Ω–æ —É—Å—Ç–∞—Ä–µ–≤—à–∏—Ö –∏–∑ –≤—ã–±–æ—Ä–∞: {removed_count}",
        parse_mode='markdown'
    )

@dp.message_handler(lambda m: m.text == "‚ùå –û—Ç–º–µ–Ω–∞")
async def cancel_handler(message: types.Message, state: FSMContext):
    current_state = await state.get_state()
    if current_state:
        await message.answer("‚ùå –î–µ–π—Å—Ç–≤–∏–µ –æ—Ç–º–µ–Ω–µ–Ω–æ", reply_markup=get_main_keyboard())
        await state.finish()
    else:
        await message.answer("‚ùå –ù–µ—Ç –∞–∫—Ç–∏–≤–Ω–æ–≥–æ –¥–µ–π—Å—Ç–≤–∏—è –¥–ª—è –æ—Ç–º–µ–Ω—ã", reply_markup=get_main_keyboard())

@dp.message_handler(commands=['clear'])
async def clear_data(message: types.Message):
    """–û—á–∏—Å—Ç–∫–∞ –≤—Å–µ—Ö –¥–∞–Ω–Ω—ã—Ö –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è"""
    user_id = message.from_user.id
    
    if user_id != Config.CREATOR_ID:
        await message.answer("‚ùå –≠—Ç–∞ –∫–æ–º–∞–Ω–¥–∞ —Ç–æ–ª—å–∫–æ –¥–ª—è —Å–æ–∑–¥–∞—Ç–µ–ª—è –±–æ—Ç–∞")
        return
    
    confirm_keyboard = InlineKeyboardMarkup()
    confirm_keyboard.add(
        InlineKeyboardButton("‚úÖ –î–∞, –æ—á–∏—Å—Ç–∏—Ç—å –≤—Å–µ", callback_data="confirm_clear"),
        InlineKeyboardButton("‚ùå –ù–µ—Ç, –æ—Ç–º–µ–Ω–∏—Ç—å", callback_data="cancel_clear")
    )
    
    await message.answer(
        "‚ö†Ô∏è *–í—ã —É–≤–µ—Ä–µ–Ω—ã —á—Ç–æ —Ö–æ—Ç–∏—Ç–µ –æ—á–∏—Å—Ç–∏—Ç—å –í–°–ï –¥–∞–Ω–Ω—ã–µ?*\n\n"
        f"‚Ä¢ –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π: {len(data_manager.users)}\n"
        f"‚Ä¢ –ê–∫—Ç–∏–≤–Ω—ã—Ö —Ä–∞—Å—Å—ã–ª–æ–∫: {len(data_manager.active_tasks)}\n\n"
        "*–≠—Ç–æ –¥–µ–π—Å—Ç–≤–∏–µ –Ω–µ–æ–±—Ä–∞—Ç–∏–º–æ!*",
        parse_mode='markdown',
        reply_markup=confirm_keyboard
    )

@dp.callback_query_handler(lambda c: c.data == 'confirm_clear')
async def confirm_clear_data(callback_query: types.CallbackQuery):
    user_id = callback_query.from_user.id
    
    if user_id != Config.CREATOR_ID:
        await callback_query.answer("‚ùå –î–æ—Å—Ç—É–ø –∑–∞–ø—Ä–µ—â–µ–Ω")
        return
    
    # –û—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –≤—Å–µ –∑–∞–¥–∞—á–∏
    for task_id, task in list(data_manager.active_tasks.items()):
        if not task.done():
            task.cancel()
            try:
                await task
            except asyncio.CancelledError:
                pass
    
    data_manager.active_tasks.clear()
    data_manager.users.clear()
    data_manager.phone_code_hashes.clear()
    
    # –£–¥–∞–ª—è–µ–º —Ñ–∞–π–ª—ã
    try:
        if Config.USERS_FILE.exists():
            Config.USERS_FILE.unlink()
        
        # –£–¥–∞–ª—è–µ–º —Å–µ—Å—Å–∏–∏
        for session_file in Config.SESSIONS_DIR.glob("session_*"):
            try:
                session_file.unlink()
            except:
                pass
    except Exception as e:
        logger.error(f"–û—à–∏–±–∫–∞ —É–¥–∞–ª–µ–Ω–∏—è —Ñ–∞–π–ª–æ–≤: {e}")
    
    await callback_query.message.edit_text(
        "‚úÖ *–í—Å–µ –¥–∞–Ω–Ω—ã–µ –æ—á–∏—â–µ–Ω—ã!*\n\n"
        "‚Ä¢ –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–∏ —É–¥–∞–ª–µ–Ω—ã\n"
        "‚Ä¢ –°–µ—Å—Å–∏–∏ —É–¥–∞–ª–µ–Ω—ã\n"
        "‚Ä¢ –†–∞—Å—Å—ã–ª–∫–∏ –æ—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω—ã",
        parse_mode='markdown'
    )
    await callback_query.answer()

@dp.callback_query_handler(lambda c: c.data == 'cancel_clear')
async def cancel_clear_data(callback_query: types.CallbackQuery):
    await callback_query.message.edit_text("‚ùå –û—á–∏—Å—Ç–∫–∞ –æ—Ç–º–µ–Ω–µ–Ω–∞")
    await callback_query.answer()

# ========== –û–ë–†–ê–ë–û–¢–ß–ò–ö –î–õ–Ø –õ–Æ–ë–´–• –î–†–£–ì–ò–• –°–û–û–ë–©–ï–ù–ò–ô ==========
@dp.message_handler()
async def handle_other_messages(message: types.Message):
    """–û–±—Ä–∞–±–æ—Ç–∫–∞ –ª—é–±—ã—Ö –¥—Ä—É–≥–∏—Ö —Å–æ–æ–±—â–µ–Ω–∏–π"""
    user_id = message.from_user.id
    user = data_manager.get_user(user_id)
    
    if not user.is_authenticated:
        await message.answer(
            "üëã *–î–æ–±—Ä–æ –ø–æ–∂–∞–ª–æ–≤–∞—Ç—å –≤ RETSING BOT!*\n\n"
            "–î–ª—è –Ω–∞—á–∞–ª–∞ —Ä–∞–±–æ—Ç—ã –æ—Ç–ø—Ä–∞–≤—å—Ç–µ —Å–≤–æ–π –∫–æ–Ω—Ç–∞–∫—Ç –∏–ª–∏ –Ω–∞–∂–º–∏—Ç–µ /start",
            parse_mode='markdown',
            reply_markup=get_contact_keyboard()
        )
    else:
        await message.answer(
            "‚ÑπÔ∏è *–ò—Å–ø–æ–ª—å–∑—É–π—Ç–µ –∫–Ω–æ–ø–∫–∏ –º–µ–Ω—é –∏–ª–∏ –∫–æ–º–∞–Ω–¥—ã:*\n\n"
            "/start - –ì–ª–∞–≤–Ω–æ–µ –º–µ–Ω—é\n"
            "/launch - –ó–∞–ø—É—Å—Ç–∏—Ç—å —Ä–∞—Å—Å—ã–ª–∫—É\n"
            "/stop - –û—Å—Ç–∞–Ω–æ–≤–∏—Ç—å —Ä–∞—Å—Å—ã–ª–∫—É\n"
            "/status - –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞\n"
            "/refresh - –û–±–Ω–æ–≤–∏—Ç—å —á–∞—Ç—ã",
            parse_mode='markdown',
            reply_markup=get_main_keyboard()
        )

# ========== –ó–ê–ü–£–°–ö ==========
async def on_startup(dp):
    """–î–µ–π—Å—Ç–≤–∏—è –ø—Ä–∏ –∑–∞–ø—É—Å–∫–µ –±–æ—Ç–∞"""
    logger.info("=" * 50)
    logger.info("üöÄ –ó–∞–ø—É—Å–∫ RETSING BOT v5.0")
    logger.info("=" * 50)
    
    # –í–æ—Å—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –∞–∫—Ç–∏–≤–Ω—ã–µ —Ä–∞—Å—Å—ã–ª–∫–∏
    restored_count = 0
    for user_id, user in list(data_manager.users.items()):
        if user.campaign_stats.is_active:
            try:
                await start_campaign_loop(user_id)
                restored_count += 1
                logger.info(f"–í–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∞ —Ä–∞—Å—Å—ã–ª–∫–∞ –¥–ª—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è {user_id}")
            except Exception as e:
                logger.error(f"–û—à–∏–±–∫–∞ –≤–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∏—è —Ä–∞—Å—Å—ã–ª–∫–∏ {user_id}: {e}")
                user.campaign_stats.stop()
                await data_manager.save_user(user)
    
    logger.info(f"–í–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–æ —Ä–∞—Å—Å—ã–ª–æ–∫: {restored_count}")
    
    # –£–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ —Å–æ–∑–¥–∞—Ç–µ–ª—é
    try:
        await bot.send_message(
            Config.CREATOR_ID,
            f"ü§ñ *RETSING BOT –∑–∞–ø—É—â–µ–Ω!*\n\n"
            f"üïê –í—Ä–µ–º—è: {datetime.now().strftime('%d.%m.%Y %H:%M')}\n"
            f"üë• –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π: {len(data_manager.users)}\n"
            f"üîÑ –í–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–æ —Ä–∞—Å—Å—ã–ª–æ–∫: {restored_count}",
            parse_mode='markdown'
        )
    except Exception as e:
        logger.error(f"–û—à–∏–±–∫–∞ –æ—Ç–ø—Ä–∞–≤–∫–∏ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è: {e}")

async def on_shutdown(dp):
    """–î–µ–π—Å—Ç–≤–∏—è –ø—Ä–∏ –≤—ã–∫–ª—é—á–µ–Ω–∏–∏ –±–æ—Ç–∞"""
    logger.info("üõë –û—Å—Ç–∞–Ω–æ–≤–∫–∞ –±–æ—Ç–∞...")
    
    # –û—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –≤—Å–µ –∞–∫—Ç–∏–≤–Ω—ã–µ —Ä–∞—Å—Å—ã–ª–∫–∏
    for user_id, task in list(data_manager.active_tasks.items()):
        if not task.done():
            task.cancel()
            try:
                await task
            except asyncio.CancelledError:
                pass
    
    # –°–æ—Ö—Ä–∞–Ω—è–µ–º –¥–∞–Ω–Ω—ã–µ
    await data_manager.save_data()
    logger.info("‚úÖ –î–∞–Ω–Ω—ã–µ —Å–æ—Ö—Ä–∞–Ω–µ–Ω—ã")

async def periodic_save():
    """–ü–µ—Ä–∏–æ–¥–∏—á–µ—Å–∫–æ–µ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ –¥–∞–Ω–Ω—ã—Ö"""
    while True:
        await asyncio.sleep(300)  # –°–æ—Ö—Ä–∞–Ω—è–µ–º –∫–∞–∂–¥—ã–µ 5 –º–∏–Ω—É—Ç
        try:
            await data_manager.save_data()
            logger.debug("–ü–µ—Ä–∏–æ–¥–∏—á–µ—Å–∫–æ–µ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ –¥–∞–Ω–Ω—ã—Ö –≤—ã–ø–æ–ª–Ω–µ–Ω–æ")
        except Exception as e:
            logger.error(f"–û—à–∏–±–∫–∞ –ø–µ—Ä–∏–æ–¥–∏—á–µ—Å–∫–æ–≥–æ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è: {e}")

async def monitor_active_campaigns():
    """–ú–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥ –∞–∫—Ç–∏–≤–Ω—ã—Ö –∫–∞–º–ø–∞–Ω–∏–π"""
    while True:
        await asyncio.sleep(30)  # –ü—Ä–æ–≤–µ—Ä—è–µ–º –∫–∞–∂–¥—ã–µ 30 —Å–µ–∫—É–Ω–¥
        
        try:
            current_time = datetime.now()
            for user_id, user in list(data_manager.users.items()):
                if user.campaign_stats.is_active and user_id not in data_manager.active_tasks:
                    # –ö–∞–º–ø–∞–Ω–∏—è –∞–∫—Ç–∏–≤–Ω–∞, –Ω–æ –∑–∞–¥–∞—á–∏ –Ω–µ—Ç - –ø–µ—Ä–µ–∑–∞–ø—É—Å–∫–∞–µ–º
                    logger.warning(f"–í–æ—Å—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –ø–æ—Ç–µ—Ä—è–Ω–Ω—É—é –∑–∞–¥–∞—á—É –¥–ª—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è {user_id}")
                    await start_campaign_loop(user_id)
        except Exception as e:
            logger.error(f"–û—à–∏–±–∫–∞ –≤ –º–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥–µ –∫–∞–º–ø–∞–Ω–∏–π: {e}")

async def send_statistics_to_creator():
    """–ï–∂–µ—á–∞—Å–Ω–∞—è –æ—Ç–ø—Ä–∞–≤–∫–∞ —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∏ —Å–æ–∑–¥–∞—Ç–µ–ª—é"""
    while True:
        await asyncio.sleep(3600)  # –ö–∞–∂–¥—ã–π —á–∞—Å
        
        try:
            active_campaigns = sum(1 for user in data_manager.users.values() if user.campaign_stats.is_active)
            total_sent = sum(user.campaign_stats.total_sent for user in data_manager.users.values())
            total_failed = sum(user.campaign_stats.total_failed for user in data_manager.users.values())
            total_users = len(data_manager.users)
            
            # –†–∞—Å—Å—á–∏—Ç—ã–≤–∞–µ–º —É—Å–ø–µ—à–Ω–æ—Å—Ç—å
            if total_sent + total_failed > 0:
                success_rate = (total_sent / (total_sent + total_failed)) * 100
            else:
                success_rate = 0
            
            await bot.send_message(
                Config.CREATOR_ID,
                f"üìä *–ï–∂–µ—á–∞—Å–Ω–∞—è —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ RETSING BOT*\n\n"
                f"üïê –í—Ä–µ–º—è: {datetime.now().strftime('%H:%M:%S')}\n"
                f"üìÖ –î–∞—Ç–∞: {datetime.now().strftime('%d.%m.%Y')}\n\n"
                f"üë• *–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–∏:*\n"
                f"‚Ä¢ –í—Å–µ–≥–æ: {total_users}\n"
                f"‚Ä¢ –ê–∫—Ç–∏–≤–Ω—ã—Ö —Ä–∞—Å—Å—ã–ª–æ–∫: {active_campaigns}\n\n"
                f"üì® *–†–∞—Å—Å—ã–ª–∫–∏:*\n"
                f"‚Ä¢ –£—Å–ø–µ—à–Ω–æ: {total_sent:,}\n"
                f"‚Ä¢ –û—à–∏–±–æ–∫: {total_failed:,}\n"
                f"‚Ä¢ –£—Å–ø–µ—à–Ω–æ—Å—Ç—å: {success_rate:.1f}%\n\n"
                f"ü§ñ *–°–∏—Å—Ç–µ–º–∞:*\n"
                f"‚Ä¢ –ê–∫—Ç–∏–≤–Ω—ã—Ö –∑–∞–¥–∞—á: {len(data_manager.active_tasks)}\n"
                f"‚Ä¢ –ó–∞–ø—É—â–µ–Ω: {datetime.now().strftime('%d.%m.%Y %H:%M')}",
                parse_mode='markdown'
            )
        except Exception as e:
            logger.error(f"–û—à–∏–±–∫–∞ –æ—Ç–ø—Ä–∞–≤–∫–∏ —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∏: {e}")

async def cleanup_old_sessions():
    """–û—á–∏—Å—Ç–∫–∞ —É—Å—Ç–∞—Ä–µ–≤—à–∏—Ö —Å–µ—Å—Å–∏–π"""
    while True:
        await asyncio.sleep(86400)  # –ö–∞–∂–¥—ã–µ 24 —á–∞—Å–∞
        
        try:
            for session_file in Config.SESSIONS_DIR.glob("session_*"):
                try:
                    # –ü—Ä–æ–≤–µ—Ä—è–µ–º –≤—Ä–µ–º—è –ø–æ—Å–ª–µ–¥–Ω–µ–≥–æ –∏–∑–º–µ–Ω–µ–Ω–∏—è
                    stat = session_file.stat()
                    last_modified = datetime.fromtimestamp(stat.st_mtime)
                    if (datetime.now() - last_modified).days > 30:
                        session_file.unlink()
                        logger.info(f"–£–¥–∞–ª–µ–Ω–∞ —É—Å—Ç–∞—Ä–µ–≤—à–∞—è —Å–µ—Å—Å–∏—è: {session_file.name}")
                except Exception as e:
                    logger.error(f"–û—à–∏–±–∫–∞ –ø—Ä–∏ –æ—á–∏—Å—Ç–∫–µ —Å–µ—Å—Å–∏–∏ {session_file}: {e}")
        except Exception as e:
            logger.error(f"–û—à–∏–±–∫–∞ –≤ –æ—á–∏—Å—Ç–∫–µ —Å–µ—Å—Å–∏–π: {e}")

if __name__ == '__main__':
    logger.info("üöÄ –ó–∞–ø—É—Å–∫ RETSING BOT...")
    
    # –ó–∞–ø—É—Å–∫–∞–µ–º —Ñ–æ–Ω–æ–≤—ã–µ –∑–∞–¥–∞—á–∏
    loop = asyncio.get_event_loop()
    loop.create_task(periodic_save())
    loop.create_task(monitor_active_campaigns())
    loop.create_task(send_statistics_to_creator())
    loop.create_task(cleanup_old_sessions())
    
    try:
        # –ó–∞–ø—É—Å–∫ –±–æ—Ç–∞
        executor.start_polling(
            dp,
            skip_updates=True,
            on_startup=on_startup,
            on_shutdown=on_shutdown,
            timeout=60
        )
    except KeyboardInterrupt:
        logger.info("üõë –ë–æ—Ç –æ—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–º")
    except Exception as e:
        logger.error(f"–ö—Ä–∏—Ç–∏—á–µ—Å–∫–∞—è –æ—à–∏–±–∫–∞: {e}")
        logger.error(traceback.format_exc())
    finally:
        logger.info("üëã RETSING BOT –∑–∞–≤–µ—Ä—à–∏–ª —Ä–∞–±–æ—Ç—É")
